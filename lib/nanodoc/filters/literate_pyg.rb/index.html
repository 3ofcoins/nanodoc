<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta content="Nanodoc 0.0.1" name="generator">
    <title></title>
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="../../../../_static/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="../../../../_static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="../../../../_static/nanodoc.css" rel="stylesheet">
  </head>
  <body>
    <div id="wrap">
      <header class="navbar">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
            <a class="brand" href="../../../../">nanodoc</a>
          </div>
        </div>
      </header>
      <div class="container-fluid">
        <div class="row-fluid">
          <nav class="span12">
            <ul class="breadcrumb">
              <li>
                <a href="../../../../">nanodoc</a>
                <span class="divider">/</span>
              </li>
              <li>
                <a href="../../../">lib</a>
                <span class="divider">/</span>
              </li>
              <li>
                <a href="../../">nanodoc</a>
                <span class="divider">/</span>
              </li>
              <li>
                <a href="../">filters</a>
                <span class="divider">/</span>
              </li>
              <li class="active">literate_pyg.rb</li>
            </ul>
          </nav>
        </div>
        <div class="row-fluid">
          <div class="span2 well well-small">
            <ul class="nav nav-list">
              <li class="active">
                <i class="icon-hand-right"></i>
                <b>literate_pyg.rb</b>
              </li>
              <li>
                <a href="../txt.rb/">
                  <i class="icon-file"></i>
                  txt.rb
                </a>
              </li>
            </ul>
          </div>
          <div class="span10">
            <table class="table literate">
              <tbody>
                <tr id="line-1">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-1">
                        1
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre><span class="nb">require</span> <span class="s1">'micromachine'</span>
<span class="nb">require</span> <span class="s1">'nanoc'</span>
<span class="nb">require</span> <span class="s1">'nanoc/filters/haml'</span>
<span class="nb">require</span> <span class="s1">'nanoc/filters/maruku'</span>
<span class="nb">require</span> <span class="s1">'nanoc/helpers/html_escape'</span>

<span class="nb">require</span> <span class="s1">'nanodoc/pygments'</span>
<span class="nb">require</span> <span class="s1">'nanodoc/site'</span></pre></td>
                </tr>
                <tr id="line-10">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-10">
                        10
                        ¶
                      </a>
                    </div>
                    <h1 id="nanodocpygmentsliteratefilter">Nanodoc::PygmentsLiterateFilter</h1>
                    
                    <p>Parses text with <a href="http://pygments.org">Pygments</a>, splits comments
                    from code, and renders it in a literate programming layout.</p>
                    
                    <p>A state machine is used to separate comment sections from code.</p>
                  </td>
                </tr>
                <tr id="line-20">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-20">
                        20
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre><span class="k">class</span> <span class="nc">Nanodoc</span><span class="o">::</span><span class="no">PygmentsLiterateFilter</span> <span class="o">&lt;</span> <span class="ss">Nanoc</span>:<span class="ss">:Filters</span><span class="o">::</span><span class="no">Haml</span>
  identifier <span class="ss">:literate_pyg</span>
  type <span class="ss">:text</span>

  requires <span class="s1">'haml'</span>
  <span class="kp">include</span> <span class="ss">Nanoc</span>:<span class="ss">:Helpers</span><span class="o">::</span><span class="no">HTMLEscape</span></pre></td>
                </tr>
                <tr id="line-27">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-27">
                        27
                        ¶
                      </a>
                    </div>
                    <h2 id="top-level-methods">Top level methods</h2>
                  </td>
                </tr>
                <tr id="line-32">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-32">
                        32
                        ¶
                      </a>
                    </div>
                    <p>Full path to the literate programming template</p>
                  </td>
                  <td class="code"><pre>  <span class="no">HAML_TEMPLATE</span> <span class="o">=</span> <span class="ss">Nanodoc</span>:<span class="ss">:Site</span><span class="o">::</span><span class="no">ROOT_DIR</span><span class="o">.</span>join(<span class="s1">'layouts'</span>, <span class="s1">'literate_pyg.haml'</span>)<span class="o">.</span>read()</pre></td>
                </tr>
                <tr id="line-35">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-35">
                        35
                        ¶
                      </a>
                    </div>
                    <h3 id="main-entry-point">Main entry point</h3>
                  </td>
                </tr>
                <tr id="line-37">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-37">
                        37
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">run</span>(content, params<span class="o">=</span>{})
    handle_parsed_file(pyg<span class="o">.</span>parsed)

    <span class="k">if</span> assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span>
      process_sections
      <span class="k">super</span>(<span class="no">HAML_TEMPLATE</span>, params)
    <span class="k">else</span>
      <span class="s2">"</span><span class="s2">&lt;pre&gt;</span><span class="si">#{</span>h(content)<span class="si">}</span><span class="s2">&lt;/pre&gt;</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-48">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-48">
                        48
                        ¶
                      </a>
                    </div>
                    <p>Returns <a href="../pygments.rb"><code>Nanodoc::Pygments</code></a> instance for current file</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">pyg</span>
    <span class="vi">@pyg</span> <span class="o">||</span><span class="o">=</span> <span class="ss">Nanodoc</span>:<span class="ss">:Pygments</span><span class="o">.</span>new(<span class="vi">@item</span>)
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-53">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-53">
                        53
                        ¶
                      </a>
                    </div>
                    <h3 id="feed-tokens-to-the-state-machine">Feed tokens to the state machine</h3>
                  </td>
                </tr>
                <tr id="line-55">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-55">
                        55
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">handle_parsed_file</span>(tokens)
    feed_bof</pre></td>
                </tr>
                <tr id="line-61">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-61">
                        61
                        ¶
                      </a>
                    </div>
                    <p>Leave token’s text and CSS class in instance variables, and
                    leave rest of work to the token state machine.</p>
                  </td>
                  <td class="code"><pre>    tokens<span class="o">.</span>each <span class="k">do</span> <span class="o">|</span>text, type, css_class<span class="o">|</span>
      feed_token(text, type, css_class)
    <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-67">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-67">
                        67
                        ¶
                      </a>
                    </div>
                    <p>Feed <abbr title="End Of File">EOF</abbr> to finalize all that needs finalizing.</p>
                  </td>
                  <td class="code"><pre>    feed_eof
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-73">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-73">
                        73
                        ¶
                      </a>
                    </div>
                    <h3 id="process-sections-for-templates">Process sections for templates</h3>
                  </td>
                </tr>
                <tr id="line-75">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-75">
                        75
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">process_sections</span>
    <span class="k">if</span> opening_comments <span class="o">=</span> assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span><span class="o">.</span>first<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span>
      opening_comments<span class="o">.</span>shift <span class="k">if</span> opening_comments<span class="o">.</span>first <span class="o">=~</span> <span class="sr">/</span><span class="sr">^</span><span class="sr">\</span><span class="sr">#</span><span class="sr">\</span><span class="sr">!</span><span class="sr">/</span>
      opening_comments<span class="o">.</span>shift <span class="k">while</span> opening_comments<span class="o">.</span>first <span class="o">=~</span> <span class="sr">/</span><span class="sr">^</span><span class="sr">\</span><span class="sr">S*</span><span class="sr">\</span><span class="sr">s*-</span><span class="sr">\</span><span class="sr">*-.*-</span><span class="sr">\</span><span class="sr">*-</span><span class="sr">\</span><span class="sr">s*$</span><span class="sr">/</span>
      opening_comments<span class="o">.</span>pop <span class="k">while</span> opening_comments<span class="o">.</span>last <span class="o">==</span> <span class="s2">"</span><span class="s2">"</span>
      assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span><span class="o">.</span>shift <span class="k">if</span> opening_comments<span class="o">.</span>empty? <span class="o">&amp;&amp;</span> <span class="o">!</span>assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span><span class="o">.</span>first<span class="o">[</span><span class="ss">:code_lines</span><span class="o">]</span>
    <span class="k">end</span>

    assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span><span class="o">.</span>each <span class="k">do</span> <span class="o">|</span>section<span class="o">|</span></pre></td>
                </tr>
                <tr id="line-87">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-87">
                        87
                        ¶
                      </a>
                    </div>
                    <p>Merge code lines into a <code>&lt;pre&gt;</code> tag.</p>
                  </td>
                  <td class="code"><pre>      <span class="k">if</span> section<span class="o">[</span><span class="ss">:code_lines</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>(section<span class="o">[</span><span class="ss">:code_lines</span><span class="o">]</span><span class="o">.</span>empty?)
        section<span class="o">[</span><span class="ss">:code</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"</span><span class="s2">&lt;pre&gt;</span><span class="si">#{</span>section<span class="o">[</span><span class="ss">:code_lines</span><span class="o">]</span><span class="o">.</span>join(<span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>)<span class="si">}</span><span class="s2">&lt;/pre&gt;</span><span class="s2">"</span>
      <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-91">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-91">
                        91
                        ¶
                      </a>
                    </div>
                    <p>Discard empty comment lines at the end; render Kramdown if
                    anything’s left.</p>
                  </td>
                  <td class="code"><pre>      <span class="k">if</span> section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span>
        section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span><span class="o">.</span>pop <span class="k">while</span> section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span><span class="o">.</span>last <span class="o">=~</span> <span class="sr">/</span><span class="sr">^</span><span class="sr">\</span><span class="sr">s*$</span><span class="sr">/</span>

        <span class="k">unless</span> section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span><span class="o">.</span>empty?</pre></td>
                </tr>
                <tr id="line-97">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-97">
                        97
                        ¶
                      </a>
                    </div>
                    <p>Strip comment prefix and whitespace. FIXME: be smarter.</p>
                  </td>
                  <td class="code"><pre>          comment_md <span class="o">=</span> section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span><span class="o">.</span>
            map { <span class="o">|</span>ln<span class="o">|</span> ln<span class="o">.</span>sub(<span class="sr">/</span><span class="sr">^</span><span class="sr">\</span><span class="sr">S+</span><span class="sr">\</span><span class="sr">s*</span><span class="sr">/</span>, <span class="s1">''</span>) }<span class="o">.</span>
            join(<span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>)

          section<span class="o">[</span><span class="ss">:comment</span><span class="o">]</span> <span class="o">=</span>
            <span class="ss">Nanoc</span>:<span class="ss">:Filters</span><span class="o">::</span><span class="no">Kramdown</span><span class="o">.</span>new<span class="o">.</span>setup_and_run(comment_md)
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-109">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-109">
                        109
                        ¶
                      </a>
                    </div>
                    <h2 id="the-token-state-machine">The Token State Machine</h2>
                    
                    <p>The event handlers use following instance attributes to handle state:</p>
                    
                    <dl>
                      <dt>@token</dt>
                      <dd>Input: <code>[text, css_class]</code> — Text of the current token, and the
                    CSS class from Pygments to highlight syntax</dd>
                      <dt>@ln</dt>
                      <dd>Line number</dd>
                      <dt>@indent</dt>
                      <dd>String of whitespace at <abbr title="Beginning Of Line">BOL</abbr>. Discarded for comments, kept for
                    code to keep indentation.</dd>
                      <dt>@is_code</dt>
                      <dd>Set at <abbr title="Beginning Of Line">BOL</abbr> to <code>false</code>, updated to <code>true</code> as soon as non-comment
                    and non-whitespace token is seen. Used to distinguish comment</dd>
                      <dt>@line_tokens</dt>
                      <dd>Array of tokens seen since <abbr title="Beginning Of Line">BOL</abbr> (without <code>@indent</code>)
                    lines from code lines.</dd>
                      <dt>@line</dt>
                      <dd>Output: a string with either cleaned raw comment text (excluding
                    indentation, including comment syntax), or HTML-formatted
                    highlighted code line including indentation, depending on
                    <code>@is_code</code>.</dd>
                    </dl>
                  </td>
                </tr>
                <tr id="line-142">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-142">
                        142
                        ¶
                      </a>
                    </div>
                    <p>“Feed <abbr title="Beginning Of File">BOF</abbr>” to the state machine, i.e. initialize it.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">feed_bof</span>
    reset_line(<span class="mi">1</span>)
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-149">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-149">
                        149
                        ¶
                      </a>
                    </div>
                    <p>Feed one token to the state machine.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">feed_token</span>(text, type, css_class)
    <span class="vi">@token</span> <span class="o">=</span> <span class="o">[</span> text, css_class <span class="o">]</span>
    token_machine<span class="o">.</span>trigger <span class="k">case</span> type
                          <span class="k">when</span> <span class="s1">'Text.Newline'</span>    <span class="k">then</span> <span class="ss">:newline</span>
                          <span class="k">when</span> <span class="s1">'Text.Whitespace'</span> <span class="k">then</span> <span class="ss">:whitespace</span>
                          <span class="k">when</span> <span class="sr">/</span><span class="sr">^Comment</span><span class="sr">/</span>        <span class="k">then</span> <span class="ss">:comment</span>
                          <span class="k">else</span>                        <span class="ss">:code</span>
                          <span class="k">end</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-160">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-160">
                        160
                        ¶
                      </a>
                    </div>
                    <p>Feed <abbr title="End Of File">EOF</abbr> to the state machine.</p>
                    
                    <p>Makes sure the machine properly handled last line if the file
                    didn’t end with a newline by triggering a <code>:newline</code> event if
                    machine isn’t at <abbr title="Beginning Of Line">BOL</abbr>.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">feed_eof</span>
    token_machine<span class="o">.</span>trigger <span class="ss">:newline</span> <span class="k">unless</span> token_machine<span class="o">.</span>state <span class="o">==</span> <span class="ss">:bol</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-172">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-172">
                        172
                        ¶
                      </a>
                    </div>
                    <p>Reset instance attributes for new line of input.</p>
                    
                    <p>If <code>ln</code> is provided, sets <code>@ln</code> to this value; otherwise, increases <code>@ln</code>.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">reset_line</span>(ln<span class="o">=</span><span class="kp">nil</span>)
    <span class="vi">@ln</span> <span class="o">=</span> ln <span class="o">||</span> (<span class="vi">@ln</span><span class="o">||</span><span class="o">-</span><span class="mi">1</span>)<span class="o">+</span><span class="mi">1</span>
    <span class="vi">@indent</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="vi">@line_tokens</span> <span class="o">=</span> <span class="o">[</span><span class="o">]</span>
    <span class="vi">@is_code</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-182">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-182">
                        182
                        ¶
                      </a>
                    </div>
                    <p>Accessor that takes care of creating the token state machine</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">token_machine</span>
    <span class="vi">@token_machine</span> <span class="o">||</span><span class="o">=</span> create_token_machine
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-187">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-187">
                        187
                        ¶
                      </a>
                    </div>
                    <h3 id="definition-of-the-token-state-machine">Definition of the token state machine</h3>
                    
                    <p><strong>States:</strong></p>
                    
                    <dl>
                      <dt>:bol</dt>
                      <dd>Beginning Of Line (BOL)</dd>
                      <dt>:indent</dt>
                      <dd>Sequence of whitespace at BOL</dd>
                      <dt>:code</dt>
                      <dd>Sequence of non-comment tokens</dd>
                      <dt>:coment</dt>
                      <dd>Sequence of comment tokens</dd>
                    </dl>
                  </td>
                </tr>
                <tr id="line-204">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-204">
                        204
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">create_token_machine</span>
    machine <span class="o">=</span> <span class="no">MicroMachine</span><span class="o">.</span>new(<span class="ss">:bol</span>)</pre></td>
                </tr>
                <tr id="line-210">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-210">
                        210
                        ¶
                      </a>
                    </div>
                    <p>Some tokens always transition to the same state</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:newline</span><span class="o">]</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span>new(<span class="ss">:bol</span>)
    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:code</span><span class="o">]</span>    <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span>new(<span class="ss">:code</span>)
    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:comment</span><span class="o">]</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span>new(<span class="ss">:comment</span>)</pre></td>
                </tr>
                <tr id="line-215">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-215">
                        215
                        ¶
                      </a>
                    </div>
                    <p>Whitespace at BOL or after indent is indent.
                    Otherwise it stays in current state.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>when <span class="ss">:whitespace</span>,
                 <span class="ss">:bol</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:indent</span>,
                 <span class="ss">:indent</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:indent</span>,
                 <span class="ss">:code</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:code</span>,
                 <span class="ss">:comment</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:comment</span>

    machine<span class="o">.</span>on(<span class="ss">:any</span>) { handle_transition(machine<span class="o">.</span>state) }

    machine
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-228">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-228">
                        228
                        ¶
                      </a>
                    </div>
                    <p>Handle token state transitions</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">handle_transition</span>(state)
    <span class="k">case</span> state</pre></td>
                </tr>
                <tr id="line-232">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-232">
                        232
                        ¶
                      </a>
                    </div>
                    <p>Transition into BOL is a newline. We render the line from
                    tokens, check its kind, and trigger event on the line state
                    machine. After the line is handled, we reset state and increase
                    the line number.</p>
                  </td>
                  <td class="code"><pre>    <span class="k">when</span> <span class="ss">:bol</span>
      line_machine<span class="o">.</span>trigger <span class="k">case</span>
                           <span class="k">when</span> <span class="vi">@line_tokens</span> <span class="o">==</span> <span class="o">[</span><span class="o">]</span>
                             <span class="vi">@line</span> <span class="o">=</span> <span class="s1">''</span>
                             <span class="ss">:empty_line</span>
                           <span class="k">when</span> <span class="vi">@is_code</span>
                             render_code_line
                             <span class="ss">:code</span>
                           <span class="k">else</span> <span class="c1"># comment line</span>
                             render_comment_line
                             <span class="k">if</span> <span class="vi">@line</span> <span class="o">=~</span> <span class="sr">/</span><span class="sr">^</span><span class="sr">\</span><span class="sr">S*</span><span class="sr">\</span><span class="sr">s*$</span><span class="sr">/</span>
                               <span class="ss">:empty_comment</span>
                             <span class="k">else</span>
                               <span class="ss">:comment</span>
                             <span class="k">end</span>
                           <span class="k">end</span>
      reset_line</pre></td>
                </tr>
                <tr id="line-254">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-254">
                        254
                        ¶
                      </a>
                    </div>
                    <p>Append whitespace to current line’s indentation.</p>
                  </td>
                  <td class="code"><pre>    <span class="k">when</span> <span class="ss">:indent</span>
      <span class="vi">@indent</span> <span class="o">&lt;&lt;</span> <span class="vi">@token</span><span class="o">.</span>first</pre></td>
                </tr>
                <tr id="line-258">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-258">
                        258
                        ¶
                      </a>
                    </div>
                    <p>Note that we’re looking at the code line, and append the
                    current token to the list.</p>
                  </td>
                  <td class="code"><pre>    <span class="k">when</span> <span class="ss">:code</span>
      <span class="vi">@line_tokens</span> <span class="o">&lt;&lt;</span> <span class="vi">@token</span>
      <span class="vi">@is_code</span> <span class="o">=</span> <span class="kp">true</span></pre></td>
                </tr>
                <tr id="line-264">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-264">
                        264
                        ¶
                      </a>
                    </div>
                    <p>Append full token to the list, as we can’t be sure before <abbr title="End Of Line">EOL</abbr>
                    that this line doesn’t contain code.</p>
                  </td>
                  <td class="code"><pre>    <span class="k">when</span> <span class="ss">:comment</span>
      <span class="vi">@line_tokens</span> <span class="o">&lt;&lt;</span> <span class="vi">@token</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-273">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-273">
                        273
                        ¶
                      </a>
                    </div>
                    <p>Render a line of code to HTML, using CSS classes from Pygments.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">render_code_line</span>
    <span class="vi">@line</span> <span class="o">=</span> <span class="vi">@indent</span> <span class="o">&lt;&lt;</span> <span class="vi">@line_tokens</span><span class="o">.</span>map! <span class="k">do</span> <span class="o">|</span>text, css_class<span class="o">|</span>
      <span class="k">if</span> css_class
        <span class="s2">"</span><span class="s2">&lt;span class=</span><span class="se">\"</span><span class="si">#{</span>css_class<span class="si">}</span><span class="se">\"</span><span class="s2">&gt;</span><span class="si">#{</span>h(text)<span class="si">}</span><span class="s2">&lt;/span&gt;</span><span class="s2">"</span>
      <span class="k">else</span>
        h(text)
      <span class="k">end</span>
    <span class="k">end</span><span class="o">.</span>join
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-284">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-284">
                        284
                        ¶
                      </a>
                    </div>
                    <p>Render a comment line by joining line tokens’ texts and stripping
                    initial non-whitespace character sequence.</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">render_comment_line</span>
    <span class="vi">@line</span> <span class="o">=</span> <span class="vi">@line_tokens</span><span class="o">.</span>map!(<span class="o">&amp;</span><span class="ss">:first</span>)<span class="o">.</span>join
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-290">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-290">
                        290
                        ¶
                      </a>
                    </div>
                    <h2 id="the-line-state-machine">The Line State Machine</h2>
                    
                    <p>The event handlers take <code>@text</code> to get current line’s text, and
                    leave their output in the <code>assigns[:sections]</code> global.</p>
                  </td>
                </tr>
                <tr id="line-297">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-297">
                        297
                        ¶
                      </a>
                    </div>
                    <p>Accessor that takes care of creating the line state machine</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">line_machine</span>
    <span class="vi">@line_machine</span> <span class="o">||</span><span class="o">=</span> create_line_machine
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-302">
                  <td colspan="2">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-302">
                        302
                        ¶
                      </a>
                    </div>
                    <h3 id="definition-of-the-line-state-machine">Definition of the line state machine</h3>
                    
                    <p><strong>States:</strong></p>
                    
                    <dl>
                      <dt>:bof</dt>
                      <dd>Beginning Of File (<abbr title="Beginning Of File">BOF</abbr>)</dd>
                      <dt>:new_code</dt>
                      <dd>Beginning of a code section (code line following <abbr title="Beginning Of File">BOF</abbr> or a wide note)</dd>
                      <dt>:new_wide_note</dt>
                      <dd>Beginning of a wide note section (empty comment line following <abbr title="Beginning Of File">BOF</abbr> or a code line)</dd>
                      <dt>:new_side_note</dt>
                      <dd>Beginning of a side note section (non-empty comment following <abbr title="Beginning Of File">BOF</abbr> or a code line)</dd>
                      <dt>:code</dt>
                      <dd>Code continuing a code section or a side note section</dd>
                      <dt>:wide_note</dt>
                      <dd>Comment continuing a wide note section</dd>
                      <dt>:side_note</dt>
                      <dd>Comment continuing a side note section</dd>
                    </dl>
                  </td>
                </tr>
                <tr id="line-329">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-329">
                        329
                        ¶
                      </a>
                    </div>
                    
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">create_line_machine</span>
    machine <span class="o">=</span> <span class="no">MicroMachine</span><span class="o">.</span>new(<span class="ss">:bof</span>)</pre></td>
                </tr>
                <tr id="line-333">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-333">
                        333
                        ¶
                      </a>
                    </div>
                    <p>Code at BOF or after wide note starts a new code section.</p>
                    
                    <p>A <code>:new_wide_note</code> state receiving <code>:code</code> means that code
                    directly follows an empty comment, which have meant beginning of
                    a code section rather than a wide note section.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:code</span><span class="o">]</span>             <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span>new(<span class="ss">:code</span>)
    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="o">[</span><span class="ss">:bof</span><span class="o">]</span>       <span class="o">=</span> <span class="ss">:new_code</span>
    machine<span class="o">.</span>transitions_for<span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="o">[</span><span class="ss">:wide_note</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:new_code</span></pre></td>
                </tr>
                <tr id="line-342">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-342">
                        342
                        ¶
                      </a>
                    </div>
                    <p>Empty comment at BOF or after code means new wide note (or new
                    code section, depending on what follows).  A sequence of empty
                    comments stays in <code>:new_wide_note</code>.  Empty comment inside a
                    section’s comment block continues the comment block.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>when <span class="ss">:empty_comment</span>,
                 <span class="ss">:bof</span> <span class="o">=</span><span class="o">&gt;</span>           <span class="ss">:new_wide_note</span>,
                 <span class="ss">:code</span> <span class="o">=</span><span class="o">&gt;</span>          <span class="ss">:new_wide_note</span>,
                 <span class="ss">:new_wide_note</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:new_wide_note</span>,
                 <span class="ss">:new_side_note</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:side_note</span>,
                 <span class="ss">:wide_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:wide_note</span>,
                 <span class="ss">:side_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:side_note</span></pre></td>
                </tr>
                <tr id="line-354">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-354">
                        354
                        ¶
                      </a>
                    </div>
                    <p>Non-empty comment at BOF or after code starts a new side note
                    section. Inside a note section’s comment block, it continues the
                    section.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>when <span class="ss">:comment</span>,
                 <span class="ss">:bof</span> <span class="o">=</span><span class="o">&gt;</span>           <span class="ss">:new_side_note</span>,
                 <span class="ss">:code</span> <span class="o">=</span><span class="o">&gt;</span>          <span class="ss">:new_side_note</span>,
                 <span class="ss">:new_wide_note</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:wide_note</span>,
                 <span class="ss">:new_side_note</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:side_note</span>,
                 <span class="ss">:wide_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:wide_note</span>,
                 <span class="ss">:side_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:side_note</span></pre></td>
                </tr>
                <tr id="line-365">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-365">
                        365
                        ¶
                      </a>
                    </div>
                    <p>Empty line usually continues current state. If an empty line (as
                    opposed to empty comment) follows a wide note’s comment block,
                    this ends the note. This way, it is possible to write multiple
                    consecutive wide note sections.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>when <span class="ss">:empty_line</span>,
                 <span class="ss">:code</span> <span class="o">=</span><span class="o">&gt;</span>          <span class="ss">:code</span>,
                 <span class="ss">:new_code</span> <span class="o">=</span><span class="o">&gt;</span>      <span class="ss">:code</span>,
                 <span class="ss">:new_wide_note</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:new_wide_note</span>,
                 <span class="ss">:new_side_node</span> <span class="o">=</span><span class="o">&gt;</span> <span class="ss">:side_note</span>,
                 <span class="ss">:wide_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:bof</span>,
                 <span class="ss">:side_note</span> <span class="o">=</span><span class="o">&gt;</span>     <span class="ss">:side_note</span></pre></td>
                </tr>
                <tr id="line-377">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-377">
                        377
                        ¶
                      </a>
                    </div>
                    <p>Entering a <code>:new_*something*</code> state starts a new section. If the
                    event line has code or comment, we add it. Continuation of a
                    code or comment block appends to current section.</p>
                  </td>
                  <td class="code"><pre>    machine<span class="o">.</span>on(<span class="ss">:new_wide_note</span>) { add_section }
    machine<span class="o">.</span>on(<span class="ss">:new_code</span>)      { add_section ; add_code }
    machine<span class="o">.</span>on(<span class="ss">:new_side_note</span>) { add_section ; add_comment }
    machine<span class="o">.</span>on(<span class="ss">:code</span>)          { add_code }
    machine<span class="o">.</span>on(<span class="ss">:wide_note</span>)     { add_comment }
    machine<span class="o">.</span>on(<span class="ss">:side_note</span>)     { add_comment }

    machine
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-390">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-390">
                        390
                        ¶
                      </a>
                    </div>
                    <p>Start a new section</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">add_section</span>(args<span class="o">=</span>{})
    (assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span> <span class="o">||</span><span class="o">=</span> <span class="o">[</span><span class="o">]</span>) <span class="o">&lt;&lt;</span> { <span class="ss">:at</span> <span class="o">=</span><span class="o">&gt;</span> <span class="vi">@ln</span> }<span class="o">.</span>merge!(args)
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-395">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-395">
                        395
                        ¶
                      </a>
                    </div>
                    <p>Adds comment line to the current section</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">add_comment</span>
    (current_section<span class="o">[</span><span class="ss">:comment_lines</span><span class="o">]</span> <span class="o">||</span><span class="o">=</span> <span class="o">[</span><span class="o">]</span>) <span class="o">&lt;&lt;</span> <span class="vi">@line</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-400">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-400">
                        400
                        ¶
                      </a>
                    </div>
                    <p>Adds code line to the current section</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">add_code</span>
    (current_section<span class="o">[</span><span class="ss">:code_lines</span><span class="o">]</span> <span class="o">||</span><span class="o">=</span> <span class="o">[</span><span class="o">]</span>) <span class="o">&lt;&lt;</span> <span class="vi">@line</span>
  <span class="k">end</span></pre></td>
                </tr>
                <tr id="line-405">
                  <td colspan="1">
                    <div class="pilwrap">
                      <a class="pilcrow" href="#line-405">
                        405
                        ¶
                      </a>
                    </div>
                    <p>Accessor for current section</p>
                  </td>
                  <td class="code"><pre>  <span class="k">def</span> <span class="nf">current_section</span>
    assigns<span class="o">[</span><span class="ss">:sections</span><span class="o">]</span><span class="o">.</span>last
  <span class="k">end</span>
<span class="k">end</span></pre></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="push"></div>
    </div>
    <footer>
      <div class="container-fluid text-center">
        <ul class="inline">
          <li>
            Generated by
            <a href="http://3ofcoins.github.io/nanodoc/">Nanodoc</a>
            version
            0.0.1
          </li>
        </ul>
      </div>
    </footer>
    <script src="../../../../_static/jquery-1.9.1.min.js"></script>
    <script src="../../../../_static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
